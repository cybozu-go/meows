name: Release runner
on:
  pull_request:
    paths:
      - "runner-images/RUNNER_VERSION"
  push:
    branches:
      - "main"
    paths:
      - "runner-images/RUNNER_VERSION"
jobs:
  get-released-versions:
    name: Get released versions for runner images
    runs-on: ubuntu-24.04
    outputs:
      meows_version: ${{ steps.meows_version.outputs.version }}
      runner_version: ${{ steps.runner_version.outputs.version }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Get meows version
        id: meows_version
        run: |
          meows_version="$(awk -F'"' '/Version =/ {print $2}' constants.go)"
          echo version=$meows_version >> $GITHUB_OUTPUT
      - name: Get runner version
        id: runner_version
        run: |
          echo version="$(cat ./runner-images/RUNNER_VERSION)" >> $GITHUB_OUTPUT
  build-and-push-runner-images:
    name: Build and push runner images
    needs: get-released-versions
    uses: ./.github/workflows/reusable-build-and-push-runner-images.yaml
    with:
      meows_version: ${{ needs.get-released-versions.outputs.meows_version }}
      runner_version: ${{ needs.get-released-versions.outputs.runner_version }}
      push_image: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
